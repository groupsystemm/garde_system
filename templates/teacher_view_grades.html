{% extends "layout.html" %}
{% block title %}üìä View Grades - Teacher{% endblock %}

{% block content %}
<div class="container mt-5">

  <!-- Back to Dashboard -->
  <a href="/teacher/dashboard" class="btn btn-secondary mb-4">‚¨ÖÔ∏è Back to Dashboard</a>

  <h3 class="mb-4">üìä All Student Grades (Your Courses)</h3>

  {% if message %}
    <div class="alert alert-success">{{ message }}</div>
  {% elif error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- Filter -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Department</label>
      <select name="department" class="form-select">
        <option value="All" {% if selected_dept == 'All' or not selected_dept %}selected{% endif %}>All</option>
        {% for dept in departments %}
        <option value="{{ dept }}" {% if dept == selected_dept %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Semester</label>
      <select name="semester" class="form-select">
        <option value="All" {% if selected_semester == 'All' or not selected_semester %}selected{% endif %}>All</option>
        {% for sem in semesters %}
        <option value="{{ sem }}" {% if sem == selected_semester %}selected{% endif %}>{{ sem }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Section</label>
      <select name="section" class="form-select">
        <option value="All" {% if selected_section == 'All' or not selected_section %}selected{% endif %}>All</option>
        {% for sec in sections %}
        <option value="{{ sec }}" {% if sec == selected_section %}selected{% endif %}>{{ sec }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">üîç Filter</button>
    </div>
  </form>

  <div class="mb-4">
    <a href="/teacher/export-grades?department={{ selected_dept }}&semester={{ selected_semester }}&section={{ selected_section }}" class="btn btn-success w-100">‚¨áÔ∏è Export to Excel</a>
  </div>

  <!-- Grades Table -->
  {% if grades %}
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Student Name</th>
        <th>Course</th>
        <th>Department</th>
        <th>Grade</th>
        <th>Comment</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for grade in grades %}
      <tr>
        <td>{{ grade.student_name }}</td>
        <td>{{ grade.course_name }}</td>
        <td>{{ grade.department_name }}</td>
        <td>{{ grade.grade }}</td>
        <td>
          <a href="#" 
             class="btn btn-sm btn-info open-comment-modal" 
             data-student="{{ grade.student_id }}" 
             data-course="{{ grade.course_id }}">
            {{ grade.comment or 'Add/View' }}
          </a>
        </td>
        <td>
          <a href="/edit-grade/{{ grade.student_id }}/{{ grade.course_id }}" class="btn btn-warning btn-sm">Edit</a>
          <a href="/delete-grade/{{ grade.student_id }}/{{ grade.course_id }}" class="btn btn-danger btn-sm"
             onclick="return confirm('Are you sure you want to delete this grade?');">Delete</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="alert alert-warning text-center">No grades found for your courses.</div>
  {% endif %}
</div>

<!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="commentForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="commentModalLabel">üí¨ Comments</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="commentsList" style="max-height: 300px; overflow-y: auto;">
            <p>Loading comments...</p>
          </div>
          <div class="mt-3">
            <label for="commentText" class="form-label">Add New Comment</label>
            <textarea id="commentText" name="comment" class="form-control" rows="4" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Send Comment</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS + your script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
  let currentStudentId = null;
  let currentCourseId = null;

  document.querySelectorAll('.open-comment-modal').forEach(button => {
    button.addEventListener('click', e => {
      e.preventDefault();
      currentStudentId = button.dataset.student;
      currentCourseId = button.dataset.course;

      document.getElementById('commentForm').action = `/teacher/add-comment/${currentStudentId}/${currentCourseId}`;
      document.getElementById('commentText').value = '';
      const commentsList = document.getElementById('commentsList');
      commentsList.innerHTML = '<p>Loading comments...</p>';

      fetch(`/api/comments/${currentStudentId}/${currentCourseId}`)
        .then(response => response.json())
        .then(data => {
          if (data.comments.length === 0) {
            commentsList.innerHTML = '<p>No comments yet.</p>';
          } else {
            commentsList.innerHTML = data.comments.map(c => `
              <div class="mb-2 p-2 border rounded">
                <strong>${c.teacher_name}</strong> <small class="text-muted">${c.created_at}</small>
                <p>${c.comment}</p>
              </div>
            `).join('');
          }
        })
        .catch(() => {
          commentsList.innerHTML = '<p>Error loading comments.</p>';
        });

      commentModal.show();
    });
  });
</script>
{% endblock %}
